---
import '../styles/beers.css';
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import { existsSync } from 'node:fs';
import { fileURLToPath } from 'node:url';
import { CATALOG_URL } from '../config/catalog';
import { loadBeers, loadCatalog } from '../utils/data-loader';
import { DEFAULT_BEER_IMAGE_PATH } from '../utils/catalog-mapper';
import fruityPaleAleImage from '../assets/images/beers/fruity-pale-ale.jpg';
import imperialStoutImage from '../assets/images/beers/imperial-stout.jpg';
import saisonImage from '../assets/images/beers/saison.jpg';
import czechLagerImage from '../assets/images/beers/czech-lager.jpg';
import apaImage from '../assets/images/beers/apa.jpg';
import fallenOnFallImage from '../assets/images/beers/Fallen-on-Fall.png';

export interface Props {
  className?: string;
}

const { className = '' } = Astro.props;
const createdBeers = await loadBeers();
const rawCatalog = await loadCatalog();
const catalogRuntimeMeta = {
  url: CATALOG_URL,
  generatedAt: rawCatalog?.generatedAt ?? null,
  pollIntervalMs: 120000
};

const beerImages: Record<string, ImageMetadata> = {
  '/beers/fruity-pale-ale.jpg': fruityPaleAleImage,
  '/beers/imperial-stout.jpg': imperialStoutImage,
  '/beers/saison.jpg': saisonImage,
  '/beers/czech-lager.jpg': czechLagerImage,
  '/beers/apa.jpg': apaImage,
  '/beers/fallen-on-fall.png': fallenOnFallImage,
  '/beers/Fallen-on-Fall.png': fallenOnFallImage
};

function resolveBeerImage(path?: string): ImageMetadata | undefined {
  if (!path) {
    return undefined;
  }

  return beerImages[path] ?? beerImages[path.toLowerCase()];
}

function resolvePublicBeerImage(path?: string): string | undefined {
  if (!path) {
    return undefined;
  }

  const normalizedWebPath = path.startsWith('/') ? path : `/${path}`;
  const normalizedFsPath = normalizedWebPath.replace(/^\//, '');
  const absolute = fileURLToPath(new URL(`../../public/${normalizedFsPath}`, import.meta.url));

  return existsSync(absolute) ? normalizedWebPath : undefined;
}

const beersForUi = createdBeers.map((beer) => ({
  ...beer,
  cardImageMeta: resolveBeerImage(beer.image),
  cardImagePath:
    resolveBeerImage(beer.image)?.src ??
    resolvePublicBeerImage(beer.image) ??
    DEFAULT_BEER_IMAGE_PATH,
  detailImage:
    resolveBeerImage(beer.image)?.src ??
    resolvePublicBeerImage(beer.image) ??
    DEFAULT_BEER_IMAGE_PATH
}));

const beersForScript = beersForUi.map(({ cardImageMeta, cardImagePath, ...beer }) => ({
  ...beer,
  detailImage: beer.detailImage ?? cardImagePath
}));

function availabilityLabel(status: string): string {
  if (status === 'available') return 'En stock';
  if (status === 'coming_soon') return 'Arrive bientôt';
  return 'Rupture de stock';
}
---

<section id="beers" class={`beers-section ${className}`} aria-labelledby="beers-title">
  <div class="beers-container">
    <div class="beers-header reveal">
      <h2 id="beers-title" class="beers-title">Nos créations</h2>
      <p class="lead">Recettes vivantes, profils aromatiques assumés, disponibilité en temps réel.</p>
    </div>

    <div class="beer-quiz-shell reveal" aria-labelledby="beer-quiz-shell-title">
      <h3 id="beer-quiz-shell-title">Trouve ta bière en 30 secondes</h3>
      <p>Le questionnaire est masqué par défaut pour garder une page épurée.</p>
      <button
        id="quiz-open-btn"
        type="button"
        class="quiz-open-btn"
        data-analytics="cta_click"
        data-analytics-label="quiz-open"
      >
        Lancer le questionnaire
      </button>
    </div>

    <div class="beers-grid reveal-stagger">
      {beersForUi.map((beer) => (
        <article id={beer.id} class="beer-card reveal" data-beer-id={beer.id}>
          <div class="beer-image">
            {beer.cardImageMeta ? (
              <Image
                src={beer.cardImageMeta}
                alt={`${beer.name} — ${beer.type}`}
                loading="lazy"
                width={800}
                height={600}
                quality={82}
                format="webp"
              />
            ) : (
              <img
                src={beer.cardImagePath}
                alt={`${beer.name} — ${beer.type}`}
                loading="lazy"
                width="800"
                height="600"
                onerror={`this.onerror=null;this.src='${DEFAULT_BEER_IMAGE_PATH}';`}
              />
            )}
          </div>

          <div class="beer-content">
            <div class="beer-meta-line">
              <span class="beer-type">{beer.type}</span>
              <span class={`beer-availability status-${beer.availability}`}>{availabilityLabel(beer.availability)}</span>
            </div>

            <h3 class="beer-name">{beer.name}</h3>
            <p class="beer-description">{beer.description}</p>

            <div class="beer-tags">
              {beer.tags.map((tag) => (
                <span class="beer-tag">{tag}</span>
              ))}
            </div>

            <div class="beer-footer">
              <span class="beer-abv">{beer.abv}</span>
              <button
                class="detail-btn js-open-beer-details"
                type="button"
                data-beer-id={beer.id}
                data-analytics="beer_detail_open"
                data-analytics-label={beer.id}
              >
                Voir la fiche
              </button>
            </div>
          </div>
        </article>
      ))}
    </div>
  </div>

  <div id="quiz-modal-overlay" class="quiz-modal-overlay" hidden></div>
  <div id="quiz-modal" class="quiz-modal" role="dialog" aria-modal="true" aria-labelledby="beer-quiz-modal-title" hidden>
    <div class="quiz-modal-content">
      <button id="quiz-close-btn" type="button" class="quiz-modal-close" aria-label="Fermer le questionnaire">&times;</button>

      <h3 id="beer-quiz-modal-title">Trouve ta bière en 5 questions</h3>
      <form id="beer-quiz-form" class="beer-quiz-form">
        <fieldset>
          <legend>Intensité recherchée</legend>
          <label><input type="radio" name="intensity" value="light" /> Légère</label>
          <label><input type="radio" name="intensity" value="balanced" /> Équilibrée</label>
          <label><input type="radio" name="intensity" value="bold" /> Puissante</label>
        </fieldset>

        <fieldset>
          <legend>Dominante aromatique</legend>
          <label><input type="radio" name="aroma" value="hoppy" /> Houblonnée</label>
          <label><input type="radio" name="aroma" value="malty" /> Maltée</label>
          <label><input type="radio" name="aroma" value="spicy" /> Épicée</label>
          <label><input type="radio" name="aroma" value="fruity" /> Fruitée</label>
        </fieldset>

        <fieldset>
          <legend>Moment de dégustation</legend>
          <label><input type="radio" name="occasion" value="apero" /> Apéro</label>
          <label><input type="radio" name="occasion" value="meal" /> À table</label>
          <label><input type="radio" name="occasion" value="cozy" /> Soirée cocooning</label>
        </fieldset>

        <fieldset>
          <legend>Finale préférée</legend>
          <label><input type="radio" name="finish" value="dry" /> Sèche</label>
          <label><input type="radio" name="finish" value="round" /> Ronde</label>
        </fieldset>

        <fieldset>
          <legend>Niveau de surprise</legend>
          <label><input type="radio" name="adventure" value="classic" /> Classique rassurant</label>
          <label><input type="radio" name="adventure" value="surprise" /> Profil audacieux</label>
        </fieldset>

        <button type="submit" class="quiz-submit" data-analytics="cta_click" data-analytics-label="quiz-submit">
          Voir ma recommandation
        </button>
      </form>

      <aside id="quiz-result" class="quiz-result" hidden aria-live="polite">
        <h4 id="quiz-result-title"></h4>
        <ul id="quiz-result-reasons"></ul>
        <button id="quiz-result-button" type="button" class="quiz-detail-btn" hidden>
          Ouvrir la fiche détaillée
        </button>
      </aside>
    </div>
  </div>

  <div id="beer-modal-overlay" class="beer-modal-overlay" hidden></div>
  <div id="beer-modal" class="beer-modal" role="dialog" aria-modal="true" aria-labelledby="beer-modal-title" hidden>
    <div class="beer-modal-content">
      <button id="beer-modal-close" type="button" class="beer-modal-close" aria-label="Fermer la fiche">&times;</button>

      <div class="beer-modal-visual">
        <img id="beer-modal-image" src="" alt="" loading="lazy" />
      </div>

      <div class="beer-modal-body">
        <p id="beer-modal-type" class="beer-modal-type"></p>
        <h3 id="beer-modal-title"></h3>
        <p id="beer-modal-description"></p>
        <p class="beer-modal-availability-label">
          Statut: <strong id="beer-modal-availability"></strong>
        </p>

        <div class="beer-modal-columns">
          <section>
            <h4>Profil</h4>
            <ul id="beer-modal-profile"></ul>
          </section>
          <section>
            <h4>Accords</h4>
            <ul id="beer-modal-pairings"></ul>
          </section>
        </div>
      </div>
    </div>
  </div>
</section>

<script id="beers-data" type="application/json" set:html={JSON.stringify(beersForScript)}></script>
<script id="catalog-runtime-meta" type="application/json" set:html={JSON.stringify(catalogRuntimeMeta)}></script>
<script>
  import '../scripts/beers-page.ts';
  import '../scripts/catalog-update-notifier.ts';
</script>
